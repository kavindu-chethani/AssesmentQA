"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_1 = require("lodash");
const strip_bom_1 = __importDefault(require("strip-bom"));
const promisified_functions_1 = require("../utils/promisified-functions");
const runtime_1 = require("../errors/runtime");
const types_1 = require("../errors/types");
const compilers_1 = require("./compilers");
const SOURCE_CHUNK_LENGTH = 1000;
class Compiler {
    constructor(sources, compilerOptions, { isCompilerServiceMode, baseUrl, experimentalEsm } = {}) {
        this.sources = sources;
        this.experimentalEsm = experimentalEsm;
        (0, compilers_1.initTestFileCompilers)(compilerOptions, { isCompilerServiceMode, baseUrl, experimentalEsm });
    }
    static getSupportedTestFileExtensions() {
        return (0, lodash_1.uniq)((0, lodash_1.flattenDeep)((0, compilers_1.getTestFileCompilers)().map(compiler => compiler.getSupportedExtension())));
    }
    static async createTestFileInfo(filename) {
        let code = null;
        try {
            code = await (0, promisified_functions_1.readFile)(filename);
        }
        catch (err) {
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.cannotFindSpecifiedTestSource, filename);
        }
        code = (0, strip_bom_1.default)(code).toString();
        const compiler = (0, lodash_1.find)((0, compilers_1.getTestFileCompilers)(), someCompiler => someCompiler.canCompile(code, filename));
        if (!compiler)
            return null;
        return {
            filename,
            code,
            compiler,
            compiledCode: null,
        };
    }
    async _createTestFilesInfo(filenames) {
        const testFilesInfo = await Promise.all(filenames.map(filename => Compiler.createTestFileInfo(filename)));
        return testFilesInfo.filter(info => !!info);
    }
    async _precompileFiles(compiler, testFilesInfo) {
        if (!compiler.canPrecompile || this.experimentalEsm && compiler.canCompileInEsm)
            return;
        const precompiledCode = await compiler.precompile(testFilesInfo);
        for (let i = 0; i < testFilesInfo.length; i++)
            testFilesInfo[i].compiledCode = precompiledCode[i];
    }
    _getCompilerTasks(testFilesInfo) {
        const tasks = new WeakMap();
        const compilers = [];
        for (const info of testFilesInfo) {
            const { compiler } = info;
            if (!tasks.has(compiler)) {
                compilers.push(compiler);
                tasks.set(compiler, []);
            }
            tasks.get(info.compiler).push(info);
        }
        return compilers.map(compiler => ({ compiler, compilerTestFilesInfo: tasks.get(compiler) }));
    }
    async _getTests({ compiler, filename, code, compiledCode }) {
        if (compiledCode || this.experimentalEsm && compiler.canCompileInEsm)
            return await compiler.execute(compiledCode, filename);
        return await compiler.compile(code, filename);
    }
    async _compileTestFiles(filenames) {
        const testFilesInfo = await this._createTestFilesInfo(filenames);
        const compilerTasks = this._getCompilerTasks(testFilesInfo);
        await Promise.all(compilerTasks.map(({ compiler, compilerTestFilesInfo }) => this._precompileFiles(compiler, compilerTestFilesInfo)));
        const tests = [];
        for (const info of testFilesInfo)
            tests.push(await this._getTests(info));
        return tests;
    }
    async getTests() {
        // NOTE: split sources into chunks because the fs module can't read all files
        // simultaneously if the number of them is too large (several thousands).
        const sourceChunks = (0, lodash_1.chunk)(this.sources, SOURCE_CHUNK_LENGTH);
        let tests = [];
        while (sourceChunks.length)
            tests = tests.concat(await this._compileTestFiles(sourceChunks.shift()));
        Compiler.cleanUp();
        return (0, lodash_1.flattenDeep)(tests).filter(test => !!test);
    }
    static cleanUp() {
        (0, compilers_1.getTestFileCompilers)().forEach(compiler => compiler.cleanUp());
    }
}
exports.default = Compiler;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tcGlsZXIvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxtQ0FLZ0I7QUFFaEIsMERBQWlDO0FBQ2pDLDBFQUEwRDtBQUMxRCwrQ0FBaUQ7QUFDakQsMkNBQWlEO0FBQ2pELDJDQUEwRTtBQUcxRSxNQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQztBQUVqQyxNQUFxQixRQUFRO0lBQ3pCLFlBQWEsT0FBTyxFQUFFLGVBQWUsRUFBRSxFQUFFLHFCQUFxQixFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsR0FBRyxFQUFFO1FBQzNGLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO1FBRXZDLElBQUEsaUNBQXFCLEVBQUMsZUFBZSxFQUFFLEVBQUUscUJBQXFCLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxDQUFDLENBQUM7SUFDaEcsQ0FBQztJQUVELE1BQU0sQ0FBQyw4QkFBOEI7UUFDakMsT0FBTyxJQUFBLGFBQUksRUFBQyxJQUFBLG9CQUFXLEVBQUMsSUFBQSxnQ0FBb0IsR0FBRSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZHLENBQUM7SUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFFLFFBQVE7UUFDckMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWhCLElBQUk7WUFDQSxJQUFJLEdBQUcsTUFBTSxJQUFBLGdDQUFRLEVBQUMsUUFBUSxDQUFDLENBQUM7U0FDbkM7UUFDRCxPQUFPLEdBQUcsRUFBRTtZQUNSLE1BQU0sSUFBSSxzQkFBWSxDQUFDLHNCQUFjLENBQUMsNkJBQTZCLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDbEY7UUFFRCxJQUFJLEdBQUcs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QUEvR0QsMkJBK0dDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBmbGF0dGVuRGVlcCxcbiAgICBmaW5kLFxuICAgIGNodW5rLFxuICAgIHVuaXEsXG59IGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCBzdHJpcEJvbSBmcm9tICdzdHJpcC1ib20nO1xuaW1wb3J0IHsgcmVhZEZpbGUgfSBmcm9tICcuLi91dGlscy9wcm9taXNpZmllZC1mdW5jdGlvbnMnO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi9lcnJvcnMvdHlwZXMnO1xuaW1wb3J0IHsgZ2V0VGVzdEZpbGVDb21waWxlcnMsIGluaXRUZXN0RmlsZUNvbXBpbGVycyB9IGZyb20gJy4vY29tcGlsZXJzJztcblxuXG5jb25zdCBTT1VSQ0VfQ0hVTktfTEVOR1RIID0gMTAwMDtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29tcGlsZXIge1xuICAgIGNvbnN0cnVjdG9yIChzb3VyY2VzLCBjb21waWxlck9wdGlvbnMsIHsgaXNDb21waWxlclNlcnZpY2VNb2RlLCBiYXNlVXJsLCBleHBlcmltZW50YWxFc20gfSA9IHt9ICkge1xuICAgICAgICB0aGlzLnNvdXJjZXMgPSBzb3VyY2VzO1xuICAgICAgICB0aGlzLmV4cGVyaW1lbnRhbEVzbSA9IGV4cGVyaW1lbnRhbEVzbTtcblxuICAgICAgICBpbml0VGVzdEZpbGVDb21waWxlcnMoY29tcGlsZXJPcHRpb25zLCB7IGlzQ29tcGlsZXJTZXJ2aWNlTW9kZSwgYmFzZVVybCwgZXhwZXJpbWVudGFsRXNtIH0pO1xuICAgIH1cblxuICAgIHN0YXRpYyBnZXRTdXBwb3J0ZWRUZXN0RmlsZUV4dGVuc2lvbnMgKCkge1xuICAgICAgICByZXR1cm4gdW5pcShmbGF0dGVuRGVlcChnZXRUZXN0RmlsZUNvbXBpbGVycygpLm1hcChjb21waWxlciA9PiBjb21waWxlci5nZXRTdXBwb3J0ZWRFeHRlbnNpb24oKSkpKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgY3JlYXRlVGVzdEZpbGVJbmZvIChmaWxlbmFtZSkge1xuICAgICAgICBsZXQgY29kZSA9IG51bGw7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvZGUgPSBhd2FpdCByZWFkRmlsZShmaWxlbmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5jYW5ub3RGaW5kU3BlY2lmaWVkVGVzdFNvdXJjZSwgZmlsZW5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29kZSA9IHN0cmlwQm9tKGNvZGUpLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgY29uc3QgY29tcGlsZXIgPSBmaW5kKGdldFRlc3RGaWxlQ29tcGlsZXJzKCksIHNvbWVDb21waWxlciA9PiBzb21lQ29tcGlsZXIuY2FuQ29tcGlsZShjb2RlLCBmaWxlbmFtZSkpO1xuXG4gICAgICAgIGlmICghY29tcGlsZXIpXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZmlsZW5hbWUsXG4gICAgICAgICAgICBjb2RlLFxuICAgICAgICAgICAgY29tcGlsZXIsXG5cbiAgICAgICAgICAgIGNvbXBpbGVkQ29kZTogbnVsbCxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBhc3luYyBfY3JlYXRlVGVzdEZpbGVzSW5mbyAoZmlsZW5hbWVzKSB7XG4gICAgICAgIGNvbnN0IHRlc3RGaWxlc0luZm8gPSBhd2FpdCBQcm9taXNlLmFsbChmaWxlbmFtZXMubWFwKGZpbGVuYW1lID0+IENvbXBpbGVyLmNyZWF0ZVRlc3RGaWxlSW5mbyhmaWxlbmFtZSkpKTtcblxuICAgICAgICByZXR1cm4gdGVzdEZpbGVzSW5mby5maWx0ZXIoaW5mbyA9PiAhIWluZm8pO1xuICAgIH1cblxuICAgIGFzeW5jIF9wcmVjb21waWxlRmlsZXMgKGNvbXBpbGVyLCB0ZXN0RmlsZXNJbmZvKSB7XG4gICAgICAgIGlmICghY29tcGlsZXIuY2FuUHJlY29tcGlsZSB8fCB0aGlzLmV4cGVyaW1lbnRhbEVzbSAmJiBjb21waWxlci5jYW5Db21waWxlSW5Fc20pXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY29uc3QgcHJlY29tcGlsZWRDb2RlID0gYXdhaXQgY29tcGlsZXIucHJlY29tcGlsZSh0ZXN0RmlsZXNJbmZvKTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRlc3RGaWxlc0luZm8ubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICB0ZXN0RmlsZXNJbmZvW2ldLmNvbXBpbGVkQ29kZSA9IHByZWNvbXBpbGVkQ29kZVtpXTtcbiAgICB9XG5cbiAgICBfZ2V0Q29tcGlsZXJUYXNrcyAodGVzdEZpbGVzSW5mbykge1xuICAgICAgICBjb25zdCB0YXNrcyAgICAgPSBuZXcgV2Vha01hcCgpO1xuICAgICAgICBjb25zdCBjb21waWxlcnMgPSBbXTtcblxuICAgICAgICBmb3IgKGNvbnN0IGluZm8gb2YgdGVzdEZpbGVzSW5mbykge1xuICAgICAgICAgICAgY29uc3QgeyBjb21waWxlciB9ID0gaW5mbztcblxuICAgICAgICAgICAgaWYgKCF0YXNrcy5oYXMoY29tcGlsZXIpKSB7XG4gICAgICAgICAgICAgICAgY29tcGlsZXJzLnB1c2goY29tcGlsZXIpO1xuICAgICAgICAgICAgICAgIHRhc2tzLnNldChjb21waWxlciwgW10pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0YXNrcy5nZXQoaW5mby5jb21waWxlcikucHVzaChpbmZvKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjb21waWxlcnMubWFwKGNvbXBpbGVyID0+ICh7IGNvbXBpbGVyLCBjb21waWxlclRlc3RGaWxlc0luZm86IHRhc2tzLmdldChjb21waWxlcikgfSkpO1xuICAgIH1cblxuICAgIGFzeW5jIF9nZXRUZXN0cyAoeyBjb21waWxlciwgZmlsZW5hbWUsIGNvZGUsIGNvbXBpbGVkQ29kZSB9KSB7XG4gICAgICAgIGlmIChjb21waWxlZENvZGUgfHwgdGhpcy5leHBlcmltZW50YWxFc20gJiYgY29tcGlsZXIuY2FuQ29tcGlsZUluRXNtKVxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNvbXBpbGVyLmV4ZWN1dGUoY29tcGlsZWRDb2RlLCBmaWxlbmFtZSk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IGNvbXBpbGVyLmNvbXBpbGUoY29kZSwgZmlsZW5hbWUpO1xuICAgIH1cblxuICAgIGFzeW5jIF9jb21waWxlVGVzdEZpbGVzIChmaWxlbmFtZXMpIHtcbiAgICAgICAgY29uc3QgdGVzdEZpbGVzSW5mbyA9IGF3YWl0IHRoaXMuX2NyZWF0ZVRlc3RGaWxlc0luZm8oZmlsZW5hbWVzKTtcbiAgICAgICAgY29uc3QgY29tcGlsZXJUYXNrcyA9IHRoaXMuX2dldENvbXBpbGVyVGFza3ModGVzdEZpbGVzSW5mbyk7XG5cbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoY29tcGlsZXJUYXNrcy5tYXAoKHsgY29tcGlsZXIsIGNvbXBpbGVyVGVzdEZpbGVzSW5mbyB9KSA9PiB0aGlzLl9wcmVjb21waWxlRmlsZXMoY29tcGlsZXIsIGNvbXBpbGVyVGVzdEZpbGVzSW5mbykpKTtcblxuICAgICAgICBjb25zdCB0ZXN0cyA9IFtdO1xuXG4gICAgICAgIGZvciAoY29uc3QgaW5mbyBvZiB0ZXN0RmlsZXNJbmZvKVxuICAgICAgICAgICAgdGVzdHMucHVzaChhd2FpdCB0aGlzLl9nZXRUZXN0cyhpbmZvKSk7XG5cbiAgICAgICAgcmV0dXJuIHRlc3RzO1xuICAgIH1cblxuICAgIGFzeW5jIGdldFRlc3RzICgpIHtcbiAgICAgICAgLy8gTk9URTogc3BsaXQgc291cmNlcyBpbnRvIGNodW5rcyBiZWNhdXNlIHRoZSBmcyBtb2R1bGUgY2FuJ3QgcmVhZCBhbGwgZmlsZXNcbiAgICAgICAgLy8gc2ltdWx0YW5lb3VzbHkgaWYgdGhlIG51bWJlciBvZiB0aGVtIGlzIHRvbyBsYXJnZSAoc2V2ZXJhbCB0aG91c2FuZHMpLlxuICAgICAgICBjb25zdCBzb3VyY2VDaHVua3MgPSBjaHVuayh0aGlzLnNvdXJjZXMsIFNPVVJDRV9DSFVOS19MRU5HVEgpO1xuXG4gICAgICAgIGxldCB0ZXN0cyA9IFtdO1xuXG4gICAgICAgIHdoaWxlIChzb3VyY2VDaHVua3MubGVuZ3RoKVxuICAgICAgICAgICAgdGVzdHMgPSB0ZXN0cy5jb25jYXQoYXdhaXQgdGhpcy5fY29tcGlsZVRlc3RGaWxlcyhzb3VyY2VDaHVua3Muc2hpZnQoKSkpO1xuXG4gICAgICAgIENvbXBpbGVyLmNsZWFuVXAoKTtcblxuICAgICAgICByZXR1cm4gZmxhdHRlbkRlZXAodGVzdHMpLmZpbHRlcih0ZXN0ID0+ICEhdGVzdCk7XG4gICAgfVxuXG4gICAgc3RhdGljIGNsZWFuVXAgKCkge1xuICAgICAgICBnZXRUZXN0RmlsZUNvbXBpbGVycygpLmZvckVhY2goY29tcGlsZXIgPT4gY29tcGlsZXIuY2xlYW5VcCgpKTtcbiAgICB9XG59XG4iXX0=