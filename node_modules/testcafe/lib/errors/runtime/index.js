"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ImportESMInCommonJSError = exports.SkipJsErrorsArgumentApiError = exports.RequestRuntimeError = exports.BrowserConnectionError = exports.TimeoutError = exports.ReporterPluginError = exports.CompositeError = exports.ClientFunctionAPIError = exports.APIError = exports.TestCompilationError = exports.GeneralError = void 0;
const templates_1 = __importDefault(require("./templates"));
const create_stack_filter_1 = __importDefault(require("../create-stack-filter"));
const get_callsite_1 = require("../get-callsite");
const render_template_1 = __importDefault(require("../../utils/render-template"));
const render_callsite_sync_1 = __importDefault(require("../../utils/render-callsite-sync"));
const types_1 = require("../types");
const get_renderes_1 = __importDefault(require("../../utils/get-renderes"));
const util_1 = __importDefault(require("util"));
const semver_1 = __importDefault(require("semver"));
const utils_1 = require("../test-run/utils");
const ERROR_SEPARATOR = '\n\n';
class ProcessTemplateInstruction {
    constructor(processFn) {
        this.processFn = processFn;
    }
}
// Errors
class GeneralError extends Error {
    constructor(...args) {
        const code = args.shift();
        const template = templates_1.default[code];
        super((0, render_template_1.default)(template, ...args));
        Object.assign(this, { code, data: args });
        Error.captureStackTrace(this, GeneralError);
    }
    static isGeneralError(arg) {
        return arg instanceof GeneralError;
    }
}
exports.GeneralError = GeneralError;
class TestCompilationError extends Error {
    constructor(originalError) {
        const template = templates_1.default[types_1.RUNTIME_ERRORS.cannotPrepareTestsDueToError];
        const errorMessage = (0, utils_1.removePreventModuleCachingSuffix)(originalError.toString());
        super((0, render_template_1.default)(template, errorMessage));
        Object.assign(this, {
            code: types_1.RUNTIME_ERRORS.cannotPrepareTestsDueToError,
            data: [errorMessage],
        });
        // NOTE: stack includes message as well.
        this.stack = (0, render_template_1.default)(template, (0, utils_1.removePreventModuleCachingSuffix)(originalError.stack));
    }
}
exports.TestCompilationError = TestCompilationError;
class APIError extends Error {
    constructor(callsite, code, ...args) {
        let template = templates_1.default[code];
        template = APIError._prepareTemplateAndArgsIfNecessary(template, args);
        const rawMessage = (0, render_template_1.default)(template, ...args);
        super((0, render_template_1.default)(templates_1.default[types_1.RUNTIME_ERRORS.cannotPrepareTestsDueToError], rawMessage));
        Object.assign(this, { code, data: args });
        // NOTE: `rawMessage` is used in error substitution if it occurs in test run.
        this.rawMessage = rawMessage;
        if (typeof callsite === 'object')
            this.callsite = callsite;
        else
            this.callsite = (0, get_callsite_1.getCallsiteForMethod)(callsite);
        // NOTE: We need property getters here because callsite can be replaced by an external code.
        // See https://github.com/DevExpress/testcafe/blob/v1.0.0/src/compiler/test-file/formats/raw.js#L22
        // Also we can't use an ES6 getter for the 'stack' property, because it will create a getter on the class prototype
        // that cannot override the instance property created by the Error parent class.
        const renderers = (0, get_renderes_1.default)(this.callsite);
        Object.defineProperties(this, {
            'stack': {
                get: () => this._createStack(renderers.noColor),
            },
            'coloredStack': {
                get: () => this._createStack(renderers.default),
            },
        });
    }
    _createStack(renderer) {
        const renderedCallsite = (0, render_callsite_sync_1.default)(this.callsite, {
            renderer: renderer,
            stackFilter: (0, create_stack_filter_1.default)(Error.stackTraceLimit),
        });
        if (!renderedCallsite)
            return this.message;
        return this.message + ERROR_SEPARATOR + renderedCallsite;
    }
    static _prepareTemplateAndArgsIfNecessary(template, args) {
        const lastArg = args.pop();
        if (lastArg instanceof ProcessTemplateInstruction)
            template = lastArg.processFn(template);
        else
            args.push(lastArg);
        return template;
    }
}
exports.APIError = APIError;
class ClientFunctionAPIError extends APIError {
    constructor(methodName, instantiationCallsiteName, code, ...args) {
        args.push(new ProcessTemplateInstruction(template => template.replace(/\{#instantiationCallsiteName\}/g, instantiationCallsiteName)));
        super(methodName, code, ...args);
    }
}
exports.ClientFunctionAPIError = ClientFunctionAPIError;
class CompositeError extends Error {
    constructor(errors) {
        super(errors.map(({ message }) => message).join(ERROR_SEPARATOR));
        this.stack = errors.map(({ stack }) => stack).join(ERROR_SEPARATOR);
        this.code = types_1.RUNTIME_ERRORS.compositeArgumentsError;
    }
}
exports.CompositeError = CompositeError;
class ReporterPluginError extends GeneralError {
    constructor({ name, method, originalError }) {
        const code = types_1.RUNTIME_ERRORS.uncaughtErrorInReporter;
        const preparedStack = ReporterPluginError._prepareStack(originalError);
        super(code, method, name, preparedStack);
    }
    static _prepareStack(err) {
        if (!(err === null || err === void 0 ? void 0 : err.stack)) {
            const inspectedObject = util_1.default.inspect(err);
            return `No stack trace is available for a raised error.\nRaised error object inspection:\n${inspectedObject}`;
        }
        return err.stack;
    }
}
exports.ReporterPluginError = ReporterPluginError;
class TimeoutError extends GeneralError {
    constructor() {
        super(types_1.RUNTIME_ERRORS.timeLimitedPromiseTimeoutExpired);
    }
}
exports.TimeoutError = TimeoutError;
class BrowserConnectionError extends GeneralError {
    constructor(...args) {
        super(types_1.RUNTIME_ERRORS.browserConnectionError, ...args);
    }
}
exports.BrowserConnectionError = BrowserConnectionError;
class RequestRuntimeError extends APIError {
    constructor(methodName, code, ...args) {
        super(methodName, code, ...args);
    }
}
exports.RequestRuntimeError = RequestRuntimeError;
class SkipJsErrorsArgumentApiError extends APIError {
    constructor(code, ...args) {
        super('skipJsErrors', code, ...args);
    }
}
exports.SkipJsErrorsArgumentApiError = SkipJsErrorsArgumentApiError;
class ImportESMInCommonJSError extends GeneralError {
    constructor(originalError, targetFile) {
        const esModule = ImportESMInCommonJSError._getESModule(originalError);
        super(types_1.RUNTIME_ERRORS.cannotImportESMInCommonsJS, esModule, targetFile);
    }
    static _getESModule(err) {
        const regExp = semver_1.default.gte(process.version, '16.0.0') ? new RegExp(/ES Module (\S*)/) : /ES Module: (\S*)/;
        const [, esModule] = err.toString().match(regExp);
        return esModule;
    }
}
exports.ImportESMInCommonJSError = ImportESMInCommonJSError;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZXJyb3JzL3J1bnRpbWUvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNERBQW9DO0FBQ3BDLGlGQUF1RDtBQUN2RCxrREFBdUQ7QUFDdkQsa0ZBQXlEO0FBQ3pELDRGQUFrRTtBQUNsRSxvQ0FBMEM7QUFDMUMsNEVBQW9EO0FBQ3BELGdEQUF3QjtBQUN4QixvREFBNEI7QUFDNUIsNkNBQXFFO0FBRXJFLE1BQU0sZUFBZSxHQUFHLE1BQU0sQ0FBQztBQUUvQixNQUFNLDBCQUEwQjtJQUM1QixZQUFhLFNBQVM7UUFDbEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7SUFDL0IsQ0FBQztDQUNKO0FBRUQsU0FBUztBQUNULE1BQWEsWUFBYSxTQUFRLEtBQUs7SUFDbkMsWUFBYSxHQUFHLElBQUk7UUFDaEIsTUFBTSxJQUFJLEdBQU8sSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzlCLE1BQU0sUUFBUSxHQUFHLG1CQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFakMsS0FBSyxDQUFDLElBQUEseUJBQWMsRUFBQyxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRXpDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQzFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVELE1BQU0sQ0FBQyxjQUFjLENBQUUsR0FBRztRQUN0QixPQUFPLEdBQUcsWUFBWSxZQUFZLENBQUM7SUFDdkMsQ0FBQztDQUNKO0FBZEQsb0NBY0M7QUFFRCxNQUFhLG9CQUFxQixTQUFRLEtBQUs7SUFDM0MsWUFBYSxhQUFhO1FBQ3RCLE1BQU0sUUFBUSxHQUFPLG1CQUFTLENBQUMsc0JB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dEQsWUFBYSxhQUFhLEVBQUUsVUFBVTtRQUNsQyxNQUFNLFFBQVEsR0FBRyx3QkFBd0IsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFdEUsS0FBSyxDQUFDLHNCQUFjLENBQUMsMEJBQTBCLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQzNFLENBQUM7SUFFRCxNQUFNLENBQUMsWUFBWSxDQUFFLEdBQUc7UUFDcEIsTUFBTSxNQUFNLEdBQVMsZ0JBQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUM7UUFDaEgsTUFBTSxDQUFDLEVBQUUsUUFBUSxDQUFDLEdBQUcsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVsRCxPQUFPLFFBQVEsQ0FBQztJQUNwQixDQUFDO0NBQ0o7QUFiRCw0REFhQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBURU1QTEFURVMgZnJvbSAnLi90ZW1wbGF0ZXMnO1xuaW1wb3J0IGNyZWF0ZVN0YWNrRmlsdGVyIGZyb20gJy4uL2NyZWF0ZS1zdGFjay1maWx0ZXInO1xuaW1wb3J0IHsgZ2V0Q2FsbHNpdGVGb3JNZXRob2QgfSBmcm9tICcuLi9nZXQtY2FsbHNpdGUnO1xuaW1wb3J0IHJlbmRlclRlbXBsYXRlIGZyb20gJy4uLy4uL3V0aWxzL3JlbmRlci10ZW1wbGF0ZSc7XG5pbXBvcnQgcmVuZGVyQ2FsbHNpdGVTeW5jIGZyb20gJy4uLy4uL3V0aWxzL3JlbmRlci1jYWxsc2l0ZS1zeW5jJztcbmltcG9ydCB7IFJVTlRJTUVfRVJST1JTIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IGdldFJlbmRlcmVycyBmcm9tICcuLi8uLi91dGlscy9nZXQtcmVuZGVyZXMnO1xuaW1wb3J0IHV0aWwgZnJvbSAndXRpbCc7XG5pbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5pbXBvcnQgeyByZW1vdmVQcmV2ZW50TW9kdWxlQ2FjaGluZ1N1ZmZpeCB9IGZyb20gJy4uL3Rlc3QtcnVuL3V0aWxzJztcblxuY29uc3QgRVJST1JfU0VQQVJBVE9SID0gJ1xcblxcbic7XG5cbmNsYXNzIFByb2Nlc3NUZW1wbGF0ZUluc3RydWN0aW9uIHtcbiAgICBjb25zdHJ1Y3RvciAocHJvY2Vzc0ZuKSB7XG4gICAgICAgIHRoaXMucHJvY2Vzc0ZuID0gcHJvY2Vzc0ZuO1xuICAgIH1cbn1cblxuLy8gRXJyb3JzXG5leHBvcnQgY2xhc3MgR2VuZXJhbEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICAgIGNvbnN0cnVjdG9yICguLi5hcmdzKSB7XG4gICAgICAgIGNvbnN0IGNvZGUgICAgID0gYXJncy5zaGlmdCgpO1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IFRFTVBMQVRFU1tjb2RlXTtcblxuICAgICAgICBzdXBlcihyZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZSwgLi4uYXJncykpO1xuXG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcywgeyBjb2RlLCBkYXRhOiBhcmdzIH0pO1xuICAgICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBHZW5lcmFsRXJyb3IpO1xuICAgIH1cblxuICAgIHN0YXRpYyBpc0dlbmVyYWxFcnJvciAoYXJnKSB7XG4gICAgICAgIHJldHVybiBhcmcgaW5zdGFuY2VvZiBHZW5lcmFsRXJyb3I7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgVGVzdENvbXBpbGF0aW9uRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gICAgY29uc3RydWN0b3IgKG9yaWdpbmFsRXJyb3IpIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgICAgID0gVEVNUExBVEVTW1JVTlRJTUVfRVJST1JTLmNhbm5vdFByZXBhcmVUZXN0c0R1ZVRvRXJyb3JdO1xuICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSByZW1vdmVQcmV2ZW50TW9kdWxlQ2FjaGluZ1N1ZmZpeChvcmlnaW5hbEVycm9yLnRvU3RyaW5nKCkpO1xuXG4gICAgICAgIHN1cGVyKHJlbmRlclRlbXBsYXRlKHRlbXBsYXRlLCBlcnJvck1lc3NhZ2UpKTtcblxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMsIHtcbiAgICAgICAgICAgIGNvZGU6IFJVTlRJTUVfRVJST1JTLmNhbm5vdFByZXBhcmVUZXN0c0R1ZVRvRXJyb3IsXG4gICAgICAgICAgICBkYXRhOiBbZXJyb3JNZXNzYWdlXSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gTk9URTogc3RhY2sgaW5jbHVkZXMgbWVzc2FnZSBhcyB3ZWxsLlxuICAgICAgICB0aGlzLnN0YWNrID0gcmVuZGVyVGVtcGxhdGUodGVtcGxhdGUsIHJlbW92ZVByZXZlbnRNb2R1bGVDYWNoaW5nU3VmZml4KG9yaWdpbmFsRXJyb3Iuc3RhY2spKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBBUElFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgICBjb25zdHJ1Y3RvciAoY2FsbHNpdGUsIGNvZGUsIC4uLmFyZ3MpIHtcbiAgICAgICAgbGV0IHRlbXBsYXRlID0gVEVNUExBVEVTW2NvZGVdO1xuXG4gICAgICAgIHRlbXBsYXRlID0gQVBJRXJyb3IuX3ByZXBhcmVUZW1wbGF0ZUFuZEFyZ3NJZk5lY2Vzc2FyeSh0ZW1wbGF0ZSwgYXJncyk7XG5cbiAgICAgICAgY29uc3QgcmF3TWVzc2FnZSA9IHJlbmRlclRlbXBsYXRlKHRlbXBsYXRlLCAuLi5hcmdzKTtcblxuICAgICAgICBzdXBlcihyZW5kZXJUZW1wbGF0ZShURU1QTEFURVNbUlVOVElNRV9FUlJPUlMuY2Fubm90UHJlcGFyZVRlc3RzRHVlVG9FcnJvcl0sIHJhd01lc3NhZ2UpKTtcblxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMsIHsgY29kZSwgZGF0YTogYXJncyB9KTtcblxuICAgICAgICAvLyBOT1RFOiBgcmF3TWVzc2FnZWAgaXMgdXNlZCBpbiBlcnJvciBzdWJzdGl0dXRpb24gaWYgaXQgb2NjdXJzIGluIHRlc3QgcnVuLlxuICAgICAgICB0aGlzLnJhd01lc3NhZ2UgPSByYXdNZXNzYWdlO1xuXG4gICAgICAgIGlmICh0eXBlb2YgY2FsbHNpdGUgPT09ICdvYmplY3QnKVxuICAgICAgICAgICAgdGhpcy5jYWxsc2l0ZSA9IGNhbGxzaXRlO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLmNhbGxzaXRlICAgPSBnZXRDYWxsc2l0ZUZvck1ldGhvZChjYWxsc2l0ZSk7XG5cbiAgICAgICAgLy8gTk9URTogV2UgbmVlZCBwcm9wZXJ0eSBnZXR0ZXJzIGhlcmUgYmVjYXVzZSBjYWxsc2l0ZSBjYW4gYmUgcmVwbGFjZWQgYnkgYW4gZXh0ZXJuYWwgY29kZS5cbiAgICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9EZXZFeHByZXNzL3Rlc3RjYWZlL2Jsb2IvdjEuMC4wL3NyYy9jb21waWxlci90ZXN0LWZpbGUvZm9ybWF0cy9yYXcuanMjTDIyXG4gICAgICAgIC8vIEFsc28gd2UgY2FuJ3QgdXNlIGFuIEVTNiBnZXR0ZXIgZm9yIHRoZSAnc3RhY2snIHByb3BlcnR5LCBiZWNhdXNlIGl0IHdpbGwgY3JlYXRlIGEgZ2V0dGVyIG9uIHRoZSBjbGFzcyBwcm90b3R5cGVcbiAgICAgICAgLy8gdGhhdCBjYW5ub3Qgb3ZlcnJpZGUgdGhlIGluc3RhbmNlIHByb3BlcnR5IGNyZWF0ZWQgYnkgdGhlIEVycm9yIHBhcmVudCBjbGFzcy5cbiAgICAgICAgY29uc3QgcmVuZGVyZXJzID0gZ2V0UmVuZGVyZXJzKHRoaXMuY2FsbHNpdGUpO1xuXG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHtcbiAgICAgICAgICAgICdzdGFjayc6IHtcbiAgICAgICAgICAgICAgICBnZXQ6ICgpID0+IHRoaXMuX2NyZWF0ZVN0YWNrKHJlbmRlcmVycy5ub0NvbG9yKSxcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgICdjb2xvcmVkU3RhY2snOiB7XG4gICAgICAgICAgICAgICAgZ2V0OiAoKSA9PiB0aGlzLl9jcmVhdGVTdGFjayhyZW5kZXJlcnMuZGVmYXVsdCksXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfY3JlYXRlU3RhY2sgKHJlbmRlcmVyKSB7XG4gICAgICAgIGNvbnN0IHJlbmRlcmVkQ2FsbHNpdGUgPSByZW5kZXJDYWxsc2l0ZVN5bmModGhpcy5jYWxsc2l0ZSwge1xuICAgICAgICAgICAgcmVuZGVyZXI6ICAgIHJlbmRlcmVyLFxuICAgICAgICAgICAgc3RhY2tGaWx0ZXI6IGNyZWF0ZVN0YWNrRmlsdGVyKEVycm9yLnN0YWNrVHJhY2VMaW1pdCksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghcmVuZGVyZWRDYWxsc2l0ZSlcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1lc3NhZ2U7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMubWVzc2FnZSArIEVSUk9SX1NFUEFSQVRPUiArIHJlbmRlcmVkQ2FsbHNpdGU7XG4gICAgfVxuXG4gICAgc3RhdGljIF9wcmVwYXJlVGVtcGxhdGVBbmRBcmdzSWZOZWNlc3NhcnkgKHRlbXBsYXRlLCBhcmdzKSB7XG4gICAgICAgIGNvbnN0IGxhc3RBcmcgPSBhcmdzLnBvcCgpO1xuXG4gICAgICAgIGlmIChsYXN0QXJnIGluc3RhbmNlb2YgUHJvY2Vzc1RlbXBsYXRlSW5zdHJ1Y3Rpb24pXG4gICAgICAgICAgICB0ZW1wbGF0ZSA9IGxhc3RBcmcucHJvY2Vzc0ZuKHRlbXBsYXRlKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgYXJncy5wdXNoKGxhc3RBcmcpO1xuXG4gICAgICAgIHJldHVybiB0ZW1wbGF0ZTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDbGllbnRGdW5jdGlvbkFQSUVycm9yIGV4dGVuZHMgQVBJRXJyb3Ige1xuICAgIGNvbnN0cnVjdG9yIChtZXRob2ROYW1lLCBpbnN0YW50aWF0aW9uQ2FsbHNpdGVOYW1lLCBjb2RlLCAuLi5hcmdzKSB7XG4gICAgICAgIGFyZ3MucHVzaChuZXcgUHJvY2Vzc1RlbXBsYXRlSW5zdHJ1Y3Rpb24odGVtcGxhdGUgPT4gdGVtcGxhdGUucmVwbGFjZSgvXFx7I2luc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWVcXH0vZywgaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSkpKTtcblxuICAgICAgICBzdXBlcihtZXRob2ROYW1lLCBjb2RlLCAuLi5hcmdzKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDb21wb3NpdGVFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgICBjb25zdHJ1Y3RvciAoZXJyb3JzKSB7XG4gICAgICAgIHN1cGVyKGVycm9ycy5tYXAoKHsgbWVzc2FnZSB9KSA9PiBtZXNzYWdlKS5qb2luKEVSUk9SX1NFUEFSQVRPUikpO1xuXG4gICAgICAgIHRoaXMuc3RhY2sgPSBlcnJvcnMubWFwKCh7IHN0YWNrIH0pID0+IHN0YWNrKS5qb2luKEVSUk9SX1NFUEFSQVRPUik7XG4gICAgICAgIHRoaXMuY29kZSAgPSBSVU5USU1FX0VSUk9SUy5jb21wb3NpdGVBcmd1bWVudHNFcnJvcjtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZXBvcnRlclBsdWdpbkVycm9yIGV4dGVuZHMgR2VuZXJhbEVycm9yIHtcbiAgICBjb25zdHJ1Y3RvciAoeyBuYW1lLCBtZXRob2QsIG9yaWdpbmFsRXJyb3IgfSkge1xuICAgICAgICBjb25zdCBjb2RlICAgICAgICAgID0gUlVOVElNRV9FUlJPUlMudW5jYXVnaHRFcnJvckluUmVwb3J0ZXI7XG4gICAgICAgIGNvbnN0IHByZXBhcmVkU3RhY2sgPSBSZXBvcnRlclBsdWdpbkVycm9yLl9wcmVwYXJlU3RhY2sob3JpZ2luYWxFcnJvcik7XG5cbiAgICAgICAgc3VwZXIoY29kZSwgbWV0aG9kLCBuYW1lLCBwcmVwYXJlZFN0YWNrKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX3ByZXBhcmVTdGFjayAoZXJyKSB7XG4gICAgICAgIGlmICghZXJyPy5zdGFjaykge1xuICAgICAgICAgICAgY29uc3QgaW5zcGVjdGVkT2JqZWN0ID0gdXRpbC5pbnNwZWN0KGVycik7XG5cbiAgICAgICAgICAgIHJldHVybiBgTm8gc3RhY2sgdHJhY2UgaXMgYXZhaWxhYmxlIGZvciBhIHJhaXNlZCBlcnJvci5cXG5SYWlzZWQgZXJyb3Igb2JqZWN0IGluc3BlY3Rpb246XFxuJHtpbnNwZWN0ZWRPYmplY3R9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlcnIuc3RhY2s7XG4gICAgfVxuXG59XG5cbmV4cG9ydCBjbGFzcyBUaW1lb3V0RXJyb3IgZXh0ZW5kcyBHZW5lcmFsRXJyb3Ige1xuICAgIGNvbnN0cnVjdG9yICgpIHtcbiAgICAgICAgc3VwZXIoUlVOVElNRV9FUlJPUlMudGltZUxpbWl0ZWRQcm9taXNlVGltZW91dEV4cGlyZWQpO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIEJyb3dzZXJDb25uZWN0aW9uRXJyb3IgZXh0ZW5kcyBHZW5lcmFsRXJyb3Ige1xuICAgIGNvbnN0cnVjdG9yICguLi5hcmdzKSB7XG4gICAgICAgIHN1cGVyKFJVTlRJTUVfRVJST1JTLmJyb3dzZXJDb25uZWN0aW9uRXJyb3IsIC4uLmFyZ3MpO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFJlcXVlc3RSdW50aW1lRXJyb3IgZXh0ZW5kcyBBUElFcnJvciB7XG4gICAgY29uc3RydWN0b3IgKG1ldGhvZE5hbWUsIGNvZGUsIC4uLmFyZ3MpIHtcbiAgICAgICAgc3VwZXIobWV0aG9kTmFtZSwgY29kZSwgLi4uYXJncyk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgU2tpcEpzRXJyb3JzQXJndW1lbnRBcGlFcnJvciBleHRlbmRzIEFQSUVycm9yIHtcbiAgICBjb25zdHJ1Y3RvciAoY29kZSwgLi4uYXJncykge1xuICAgICAgICBzdXBlcignc2tpcEpzRXJyb3JzJywgY29kZSwgLi4uYXJncyk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgSW1wb3J0RVNNSW5Db21tb25KU0Vycm9yIGV4dGVuZHMgR2VuZXJhbEVycm9yIHtcbiAgICBjb25zdHJ1Y3RvciAob3JpZ2luYWxFcnJvciwgdGFyZ2V0RmlsZSkge1xuICAgICAgICBjb25zdCBlc01vZHVsZSA9IEltcG9ydEVTTUluQ29tbW9uSlNFcnJvci5fZ2V0RVNNb2R1bGUob3JpZ2luYWxFcnJvcik7XG5cbiAgICAgICAgc3VwZXIoUlVOVElNRV9FUlJPUlMuY2Fubm90SW1wb3J0RVNNSW5Db21tb25zSlMsIGVzTW9kdWxlLCB0YXJnZXRGaWxlKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2dldEVTTW9kdWxlIChlcnIpIHtcbiAgICAgICAgY29uc3QgcmVnRXhwICAgICAgID0gc2VtdmVyLmd0ZShwcm9jZXNzLnZlcnNpb24sICcxNi4wLjAnKSA/IG5ldyBSZWdFeHAoL0VTIE1vZHVsZSAoXFxTKikvKSA6IC9FUyBNb2R1bGU6IChcXFMqKS87XG4gICAgICAgIGNvbnN0IFssIGVzTW9kdWxlXSA9IGVyci50b1N0cmluZygpLm1hdGNoKHJlZ0V4cCk7XG5cbiAgICAgICAgcmV0dXJuIGVzTW9kdWxlO1xuICAgIH1cbn1cbiJdfQ==