"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MessageSerializer = exports.MessageParser = void 0;
const packet_1 = __importDefault(require("./packet"));
const runtime_1 = require("../../../errors/runtime");
const types_1 = require("../../../errors/types");
const create_replicator_1 = __importDefault(require("../../serialization/replicator/create-replicator"));
const replicator = (0, create_replicator_1.default)();
class MessageParser {
    constructor() {
        this.dataQueue = [];
        this.packetQueue = [];
    }
    static _concatPackets(packets) {
        const data = packets.map(packet => packet.data);
        return Buffer.concat(data);
    }
    _processPacket(packet) {
        if (packet.header.tail) {
            if (!packet.header.head && this.packetQueue.length === 0)
                throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.unexpectedIPCTailPacket);
            const packets = this.packetQueue.splice(0, this.packetQueue.length);
            const data = packet.header.head ? packet.data : MessageParser._concatPackets([...packets, packet]);
            const stringified = data.toString();
            try {
                return replicator.decode(stringified);
            }
            catch (e) {
                if (e instanceof Error)
                    e.message += `\n${stringified}\n`;
                throw e;
            }
        }
        if (packet.header.head && this.packetQueue.length !== 0) {
            this.packetQueue.splice(0, this.packetQueue.length);
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.unexpectedIPCHeadPacket);
        }
        if (!packet.header.head && !packet.header.tail && this.packetQueue.length === 0)
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.unexpectedIPCBodyPacket);
        this.packetQueue.push(packet);
        return void 0;
    }
    _processData() {
        let buffer = Buffer.concat(this.dataQueue.splice(0, this.dataQueue.length));
        let packet = packet_1.default.parse(buffer);
        const messages = [];
        while (packet) {
            const message = this._processPacket(packet);
            if (message)
                messages.push(message);
            buffer = buffer.slice(packet.header.totalSize);
            packet = packet_1.default.parse(buffer);
        }
        if (buffer.length)
            this.dataQueue.unshift(buffer);
        return messages;
    }
    parse(data) {
        this.dataQueue.push(data);
        return this._processData();
    }
}
exports.MessageParser = MessageParser;
class MessageSerializer {
    static _chunkData(data) {
        const chunks = [];
        for (let index = 0; index < data.length; index += packet_1.default.MAX_PAYLOAD_SIZE) {
            const size = Math.min(data.length - index, packet_1.default.MAX_PAYLOAD_SIZE);
            const head = index === 0;
            const tail = index + size >= data.length;
            chunks.push(packet_1.default.serialize(data.slice(index, index + size), { head, tail }));
        }
        return chunks;
    }
    serialize(message) {
        const encodedMessage = replicator.encode(message);
        return MessageSerializer._chunkData(Buffer.from(encodedMessage));
    }
}
exports.MessageSerializer = MessageSerializer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zZXJ2aWNlcy91dGlscy9pcGMvbWVzc2FnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxzREFBMkQ7QUFDM0QscURBQXVEO0FBQ3ZELGlEQUF1RDtBQUN2RCx5R0FBZ0Y7QUFFaEYsTUFBTSxVQUFVLEdBQUcsSUFBQSwyQkFBZ0IsR0FBRSxDQUFDO0FBRXRDLE1BQWEsYUFBYTtJQUl0QjtRQUNJLElBQUksQ0FBQyxTQUFTLEdBQUssRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFTyxNQUFNLENBQUMsY0FBYyxDQUFFLE9BQXVCO1FBQ2xELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFaEQsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFTyxjQUFjLENBQUUsTUFBb0I7UUFDeEMsSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRTtZQUNwQixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEtBQUssQ0FBQztnQkFDcEQsTUFBTSxJQUFJLHNCQUFZLENBQUMsc0JBQWMsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1lBRW5FLE1BQU0sT0FBTyxHQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3hFLE1BQU0sSUFBSSxHQUFVLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLENBQUMsR0FBRyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUMxRyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFFcEMsSUFBSTtnQkFDQSxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFXLENBQUM7YUFDbkQ7WUFDRCxPQUFPLENBQUMsRUFBRTtnQkFDTixJQUFJLENBQUMsWUFBWSxLQUFLO29CQUNsQixDQUFDLENBQUMsT0FBTyxJQUFJLEtBQUssV0FBVyxJQUFJLENBQUM7Z0JBRXRDLE1BQU0sQ0FBQyxDQUFDO2FBQ1g7U0FDSjtRQUVELElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ3JELElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXBELE1BQU0sSUFBSSxzQkFBWSxDQUFDLHNCQUFjLENBQUMsdUJBQXVCLENBQUMsQ0FBQztTQUNsRTtRQUVELElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxLQUFLLENBQUM7WUFDM0UsTUFBTSxJQUFJLHNCQUFZLENBQUMsc0JBQWMsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBRW5FLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTlCLE9BQU8sS0FBSyxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUVPLFlBQVk7UUFDaEIsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQzVFLElBQUksTUFBTSxHQUFHLGdCQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRWxDLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUVwQixPQUFPLE1BQU0sRUFBRTtZQUNYLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFNUMsSUFBSSxPQUFPO2dCQUNQLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFM0IsTUFBTSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUUvQyxNQUFNLEdBQUcsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDakM7UUFFRCxJQUFJLE1BQU0sQ0FBQyxNQUFNO1lBQ2IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFbkMsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztJQUVNLEtBQUssQ0FBRSxJQUFZO1FBQ3RCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTFCLE9BQU8sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQy9CLENBQUM7Q0FDSjtBQTdFRCxzQ0E2RUM7QUFFRCxNQUFhLGlCQUFpQjtJQUNsQixNQUFNLENBQUMsVUFBVSxDQUFFLElBQVk7UUFDbkMsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBRWxCLEtBQUssSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEtBQUssSUFBSSxnQkFBTSxDQUFDLGdCQUFnQixFQUFFO1lBQ3ZFLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLEVBQUUsZ0JBQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3BFLE1BQU0sSUFBSSxHQUFHLEtBQUssS0FBSyxDQUFDLENBQUM7WUFDekIsTUFBTSxJQUFJLEdBQUcsS0FBSyxHQUFHLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDO1lBRXpDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsS0FBSyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztTQUNsRjtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFFTSxTQUFTLENBQUUsT0FBZTtRQUM3QixNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRWxELE9BQU8saUJBQWlCLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztJQUNyRSxDQUFDO0NBQ0o7QUFwQkQsOENBb0JDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVmYXVsdCBhcyBQYWNrZXQsIFBhcnNlZFBhY2tldCB9IGZyb20gJy4vcGFja2V0JztcbmltcG9ydCB7IEdlbmVyYWxFcnJvciB9IGZyb20gJy4uLy4uLy4uL2Vycm9ycy9ydW50aW1lJztcbmltcG9ydCB7IFJVTlRJTUVfRVJST1JTIH0gZnJvbSAnLi4vLi4vLi4vZXJyb3JzL3R5cGVzJztcbmltcG9ydCBjcmVhdGVSZXBsaWNhdG9yIGZyb20gJy4uLy4uL3NlcmlhbGl6YXRpb24vcmVwbGljYXRvci9jcmVhdGUtcmVwbGljYXRvcic7XG5cbmNvbnN0IHJlcGxpY2F0b3IgPSBjcmVhdGVSZXBsaWNhdG9yKCk7XG5cbmV4cG9ydCBjbGFzcyBNZXNzYWdlUGFyc2VyIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRhdGFRdWV1ZTogQnVmZmVyW107XG4gICAgcHJpdmF0ZSByZWFkb25seSBwYWNrZXRRdWV1ZTogUGFyc2VkUGFja2V0W107XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IgKCkge1xuICAgICAgICB0aGlzLmRhdGFRdWV1ZSAgID0gW107XG4gICAgICAgIHRoaXMucGFja2V0UXVldWUgPSBbXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfY29uY2F0UGFja2V0cyAocGFja2V0czogUGFyc2VkUGFja2V0W10pOiBCdWZmZXIge1xuICAgICAgICBjb25zdCBkYXRhID0gcGFja2V0cy5tYXAocGFja2V0ID0+IHBhY2tldC5kYXRhKTtcblxuICAgICAgICByZXR1cm4gQnVmZmVyLmNvbmNhdChkYXRhKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9wcm9jZXNzUGFja2V0IChwYWNrZXQ6IFBhcnNlZFBhY2tldCk6IG9iamVjdHx1bmRlZmluZWQge1xuICAgICAgICBpZiAocGFja2V0LmhlYWRlci50YWlsKSB7XG4gICAgICAgICAgICBpZiAoIXBhY2tldC5oZWFkZXIuaGVhZCAmJiB0aGlzLnBhY2tldFF1ZXVlLmxlbmd0aCA9PT0gMClcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLnVuZXhwZWN0ZWRJUENUYWlsUGFja2V0KTtcblxuICAgICAgICAgICAgY29uc3QgcGFja2V0cyAgICAgPSB0aGlzLnBhY2tldFF1ZXVlLnNwbGljZSgwLCB0aGlzLnBhY2tldFF1ZXVlLmxlbmd0aCk7XG4gICAgICAgICAgICBjb25zdCBkYXRhICAgICAgICA9IHBhY2tldC5oZWFkZXIuaGVhZCA/IHBhY2tldC5kYXRhIDogTWVzc2FnZVBhcnNlci5fY29uY2F0UGFja2V0cyhbLi4ucGFja2V0cywgcGFja2V0XSk7XG4gICAgICAgICAgICBjb25zdCBzdHJpbmdpZmllZCA9IGRhdGEudG9TdHJpbmcoKTtcblxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVwbGljYXRvci5kZWNvZGUoc3RyaW5naWZpZWQpIGFzIG9iamVjdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBFcnJvcilcbiAgICAgICAgICAgICAgICAgICAgZS5tZXNzYWdlICs9IGBcXG4ke3N0cmluZ2lmaWVkfVxcbmA7XG5cbiAgICAgICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBhY2tldC5oZWFkZXIuaGVhZCAmJiB0aGlzLnBhY2tldFF1ZXVlLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgdGhpcy5wYWNrZXRRdWV1ZS5zcGxpY2UoMCwgdGhpcy5wYWNrZXRRdWV1ZS5sZW5ndGgpO1xuXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLnVuZXhwZWN0ZWRJUENIZWFkUGFja2V0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcGFja2V0LmhlYWRlci5oZWFkICYmICFwYWNrZXQuaGVhZGVyLnRhaWwgJiYgdGhpcy5wYWNrZXRRdWV1ZS5sZW5ndGggPT09IDApXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLnVuZXhwZWN0ZWRJUENCb2R5UGFja2V0KTtcblxuICAgICAgICB0aGlzLnBhY2tldFF1ZXVlLnB1c2gocGFja2V0KTtcblxuICAgICAgICByZXR1cm4gdm9pZCAwO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3Byb2Nlc3NEYXRhICgpOiBvYmplY3RbXSB7XG4gICAgICAgIGxldCBidWZmZXIgPSBCdWZmZXIuY29uY2F0KHRoaXMuZGF0YVF1ZXVlLnNwbGljZSgwLCB0aGlzLmRhdGFRdWV1ZS5sZW5ndGgpKTtcbiAgICAgICAgbGV0IHBhY2tldCA9IFBhY2tldC5wYXJzZShidWZmZXIpO1xuXG4gICAgICAgIGNvbnN0IG1lc3NhZ2VzID0gW107XG5cbiAgICAgICAgd2hpbGUgKHBhY2tldCkge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IHRoaXMuX3Byb2Nlc3NQYWNrZXQocGFja2V0KTtcblxuICAgICAgICAgICAgaWYgKG1lc3NhZ2UpXG4gICAgICAgICAgICAgICAgbWVzc2FnZXMucHVzaChtZXNzYWdlKTtcblxuICAgICAgICAgICAgYnVmZmVyID0gYnVmZmVyLnNsaWNlKHBhY2tldC5oZWFkZXIudG90YWxTaXplKTtcblxuICAgICAgICAgICAgcGFja2V0ID0gUGFja2V0LnBhcnNlKGJ1ZmZlcik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYnVmZmVyLmxlbmd0aClcbiAgICAgICAgICAgIHRoaXMuZGF0YVF1ZXVlLnVuc2hpZnQoYnVmZmVyKTtcblxuICAgICAgICByZXR1cm4gbWVzc2FnZXM7XG4gICAgfVxuXG4gICAgcHVibGljIHBhcnNlIChkYXRhOiBCdWZmZXIpOiBvYmplY3RbXSB7XG4gICAgICAgIHRoaXMuZGF0YVF1ZXVlLnB1c2goZGF0YSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2Nlc3NEYXRhKCk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTWVzc2FnZVNlcmlhbGl6ZXIge1xuICAgIHByaXZhdGUgc3RhdGljIF9jaHVua0RhdGEgKGRhdGE6IEJ1ZmZlcik6IEJ1ZmZlcltdIHtcbiAgICAgICAgY29uc3QgY2h1bmtzID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGRhdGEubGVuZ3RoOyBpbmRleCArPSBQYWNrZXQuTUFYX1BBWUxPQURfU0laRSkge1xuICAgICAgICAgICAgY29uc3Qgc2l6ZSA9IE1hdGgubWluKGRhdGEubGVuZ3RoIC0gaW5kZXgsIFBhY2tldC5NQVhfUEFZTE9BRF9TSVpFKTtcbiAgICAgICAgICAgIGNvbnN0IGhlYWQgPSBpbmRleCA9PT0gMDtcbiAgICAgICAgICAgIGNvbnN0IHRhaWwgPSBpbmRleCArIHNpemUgPj0gZGF0YS5sZW5ndGg7XG5cbiAgICAgICAgICAgIGNodW5rcy5wdXNoKFBhY2tldC5zZXJpYWxpemUoZGF0YS5zbGljZShpbmRleCwgaW5kZXggKyBzaXplKSwgeyBoZWFkLCB0YWlsIH0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjaHVua3M7XG4gICAgfVxuXG4gICAgcHVibGljIHNlcmlhbGl6ZSAobWVzc2FnZTogb2JqZWN0KTogQnVmZmVyW10ge1xuICAgICAgICBjb25zdCBlbmNvZGVkTWVzc2FnZSA9IHJlcGxpY2F0b3IuZW5jb2RlKG1lc3NhZ2UpO1xuXG4gICAgICAgIHJldHVybiBNZXNzYWdlU2VyaWFsaXplci5fY2h1bmtEYXRhKEJ1ZmZlci5mcm9tKGVuY29kZWRNZXNzYWdlKSk7XG4gICAgfVxufVxuIl19